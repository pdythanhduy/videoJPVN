<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Token Preservation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .token {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #444;
            border: 1px solid #666;
        }
        .token.problem {
            background: #f43f5e;
            border-color: #fb7185;
        }
        .token.correct {
            background: #10b981;
            border-color: #34d399;
        }
        .highlight-test {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>JSON Token Preservation Test</h1>
        
        <div class="test-section">
            <h2>Original JSON Data</h2>
            <p>Testing specific problematic tokens from your JSON data.</p>
            
            <div id="original-tokens"></div>
        </div>
        
        <div class="test-section">
            <h2>Vocabulary Filter Test</h2>
            <p>Testing vocabulary extraction with NOUN, VERB, ADV filter.</p>
            
            <div id="vocab-filter-test"></div>
        </div>
        
        <div class="test-section">
            <h2>Token Splitting Analysis</h2>
            <p>Analyzing why tokens might be getting split.</p>
            
            <div id="splitting-analysis"></div>
        </div>
    </div>

    <script>
        // Your JSON data with problematic tokens
        const testData = {
            "segments": [
                {
                    "start": 0,
                    "end": 8.72,
                    "jp": "ある大学の寮で不思議な出来事がよく起こると言われています 夜になると廊下から足音が聞こえてきます",
                    "vi": "Người ta nói rằng ở ký túc xá của một trường đại học nọ, những chuyện kỳ lạ thường xuyên xảy ra. Cứ đêm đến là lại nghe thấy tiếng bước chân từ hành lang.",
                    "tokens": [
                        {
                            "ja": "ある大学の寮で",
                            "reading": "あるだいがくのりょうで",
                            "pos": "",
                            "vi": "ở ký túc xá của một trường đại học nọ"
                        },
                        {
                            "ja": "不思議な出来事",
                            "reading": "ふしぎなできごと",
                            "pos": "",
                            "vi": "những chuyện kỳ lạ"
                        },
                        {
                            "ja": "が",
                            "reading": "が",
                            "pos": "",
                            "vi": "(trợ từ)"
                        },
                        {
                            "ja": "よく",
                            "reading": "よく",
                            "pos": "",
                            "vi": "thường xuyên"
                        },
                        {
                            "ja": "起こる",
                            "reading": "おこる",
                            "pos": "",
                            "vi": "xảy ra"
                        },
                        {
                            "ja": "と",
                            "reading": "と",
                            "pos": "",
                            "vi": "là"
                        },
                        {
                            "ja": "言われています",
                            "reading": "いわれています",
                            "pos": "",
                            "vi": "người ta nói rằng"
                        },
                        {
                            "ja": "夜になると",
                            "reading": "よるになると",
                            "pos": "",
                            "vi": "cứ đêm đến"
                        },
                        {
                            "ja": "廊下から",
                            "reading": "ろうかから",
                            "pos": "",
                            "vi": "từ hành lang"
                        },
                        {
                            "ja": "足音",
                            "reading": "あしおと",
                            "pos": "",
                            "vi": "tiếng bước chân"
                        },
                        {
                            "ja": "が",
                            "reading": "が",
                            "pos": "",
                            "vi": "(trợ từ)"
                        },
                        {
                            "ja": "聞こえてきます",
                            "reading": "きこえてきます",
                            "pos": "",
                            "vi": "nghe thấy"
                        }
                    ]
                },
                {
                    "start": 15.86,
                    "end": 24.6,
                    "jp": "時計を見るともう午前2時でした 突然ドアをコンコンとノックする音がしました",
                    "vi": "Nhìn đồng hồ thì đã 2 giờ sáng. Đột nhiên, có tiếng gõ cửa \"cốc, cốc\".",
                    "tokens": [
                        {
                            "ja": "時計を見ると",
                            "reading": "とけいをみると",
                            "pos": "",
                            "vi": "nhìn đồng hồ thì"
                        },
                        {
                            "ja": "もう",
                            "reading": "もう",
                            "pos": "",
                            "vi": "đã"
                        },
                        {
                            "ja": "午前2時でした",
                            "reading": "ごぜんにじでした",
                            "pos": "",
                            "vi": "2 giờ sáng"
                        },
                        {
                            "ja": "突然",
                            "reading": "とつぜん",
                            "pos": "",
                            "vi": "đột nhiên"
                        },
                        {
                            "ja": "ドアを",
                            "reading": "どあを",
                            "pos": "",
                            "vi": "cửa"
                        },
                        {
                            "ja": "コンコンと",
                            "reading": "こんこんと",
                            "pos": "",
                            "vi": "\"cốc cốc\""
                        },
                        {
                            "ja": "ノックする音",
                            "reading": "のっくするおと",
                            "pos": "",
                            "vi": "tiếng gõ"
                        },
                        {
                            "ja": "がしました",
                            "reading": "がしました",
                            "pos": "",
                            "vi": "vang lên"
                        }
                    ]
                }
            ]
        };

        // Simulate the vocabulary extraction logic with NOUN, VERB, ADV filter
        function extractVocabulary(segments) {
            const allVocab = [];
            
            for (const segment of segments) {
                const vocabEntries = [];
                const seen = new Set();
                
                for (const tk of segment.tokens || []) {
                    const pos = String(tk?.pos || '').toUpperCase();
                    const surface = String(tk?.surface || '').trim();
                    if (!surface || seen.has(surface)) continue;
                    
                    // Check if token has Vietnamese translation
                    const vi = String(tk?.vi || '').trim();
                    if (!vi) continue;
                    
                    // Filter meaningful words: only NOUN, VERB, ADV with translation
                    const isMeaningful = (pos === 'NOUN' || pos === 'VERB' || pos === 'ADV') && vi.length > 0;
                    
                    if (!isMeaningful) continue;
                    
                    seen.add(surface);
                    vocabEntries.push({
                        surface,
                        reading: String(tk?.reading || '').trim(),
                        vi,
                        pos: pos || 'OTHER'
                    });
                }
                
                allVocab.push({
                    segment: segment.jp,
                    vocab: vocabEntries
                });
            }
            
            return allVocab;
        }

        // Check for problematic tokens that might be getting split
        function analyzeTokenSplitting(segments) {
            const problems = [];
            
            for (const segment of segments) {
                for (const token of segment.tokens || []) {
                    const surface = token.ja || '';
                    const vi = token.vi || '';
                    
                    // Check for potential splitting issues
                    if (surface.includes('でした') && !vi.includes('giờ')) {
                        problems.push({
                            token: surface,
                            vi: vi,
                            issue: 'Contains "でした" but not time-related - might be split',
                            expected: 'Should be one token for time expressions'
                        });
                    }
                    
                    if (surface.includes('驚いて') && vi.includes('giật mình')) {
                        problems.push({
                            token: surface,
                            vi: vi,
                            issue: 'Verb with te-form - might be split into parts',
                            expected: 'Should stay as one token'
                        });
                    }
                }
            }
            
            return problems;
        }

        // Display results
        const originalDiv = document.getElementById('original-tokens');
        const vocabDiv = document.getElementById('vocab-filter-test');
        const analysisDiv = document.getElementById('splitting-analysis');

        // Original tokens display
        let allTokens = [];
        testData.segments.forEach(seg => {
            allTokens = allTokens.concat(seg.tokens);
        });

        originalDiv.innerHTML = `
            <h3>All Tokens from JSON (${allTokens.length} total):</h3>
            <div style="margin: 10px 0;">
                ${allTokens.map((token, idx) => `
                    <div class="token ${token.ja.includes('でした') || token.ja.includes('驚いて') ? 'problem' : 'correct'}" style="margin: 2px;">
                        <strong>${token.ja}</strong><br>
                        <small>${token.reading}</small><br>
                        <small style="color: #10b981;">${token.vi}</small><br>
                        <small style="color: #fbbf24;">POS: ${token.pos || 'EMPTY'}</small>
                    </div>
                `).join('')}
            </div>
        `;

        // Vocabulary filter test
        const vocabResults = extractVocabulary(testData.segments);
        vocabDiv.innerHTML = `
            <h3>Vocabulary Extraction Results (NOUN, VERB, ADV only):</h3>
            ${vocabResults.map((result, segIdx) => `
                <div style="margin: 15px 0; padding: 10px; background: #444; border-radius: 4px;">
                    <h4>Segment ${segIdx + 1}: ${result.segment}</h4>
                    <p>Found ${result.vocab.length} vocabulary items:</p>
                    <div style="margin: 10px 0;">
                        ${result.vocab.map(entry => `
                            <div class="token" style="margin: 2px; background: #3b82f6;">
                                <strong>${entry.surface}</strong><br>
                                <small>${entry.reading}</small><br>
                                <small style="color: #10b981;">${entry.vi}</small><br>
                                <small style="color: #fbbf24;">${entry.pos}</small>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('')}
        `;

        // Splitting analysis
        const problems = analyzeTokenSplitting(testData.segments);
        analysisDiv.innerHTML = `
            <h3>Token Splitting Analysis:</h3>
            <div style="margin: 10px 0;">
                ${problems.length > 0 ? problems.map(problem => `
                    <div style="background: #f43f5e; padding: 10px; margin: 5px 0; border-radius: 4px;">
                        <strong>Problem Token:</strong> "${problem.token}"<br>
                        <strong>Translation:</strong> ${problem.vi}<br>
                        <strong>Issue:</strong> ${problem.issue}<br>
                        <strong>Expected:</strong> ${problem.expected}
                    </div>
                `).join('') : '<p style="color: #10b981;">No obvious splitting issues detected in JSON data.</p>'}
            </div>
            
            <h3>Key Findings:</h3>
            <div style="background: #444; padding: 15px; border-radius: 4px;">
                <p><strong>1. JSON Data Integrity:</strong> All tokens appear to be intact in the JSON data.</p>
                <p><strong>2. Vocabulary Filter:</strong> With NOUN/VERB/ADV filter, most tokens are excluded (empty POS tags).</p>
                <p><strong>3. Potential Issue:</strong> If tokens are being split during display, it's likely happening in the rendering logic, not the data.</p>
                <p><strong>4. Recommendation:</strong> Check the highlight rendering code to ensure it uses the original token surfaces.</p>
            </div>
        `;

        console.log('Analysis Results:', {
            totalTokens: allTokens.length,
            vocabResults: vocabResults,
            problems: problems
        });
    </script>
</body>
</html>
